@model List<Arca.Shared.Models.Semilla>

@{
    ViewBag.Title = "Inventario de Semillas";
    var especies = ViewBag.Especies as SelectList;
    int? especieIdSel = ViewBag.EspecieIdSeleccionada as int?;
}

<h1 class="h1-Index">Inventario de Semillas</h1>

<div class="button-container" style="margin-top:30px;">
    @Html.ActionLink("Agregar Semilla", "Create", "Semilla", null, new { @class = "button" })
</div>

<div class="form-container">
    @if (TempData["Mensaje"] != null)
    {<p style="color:green;text-align:center;">@TempData["Mensaje"]</p>}
    @if (TempData["Error"] != null)
    {<p style="color:red;text-align:center;">@TempData["Error"]</p>}

    <div style="margin: 10px auto; text-align:center;">
        <label for="filtroEspecie">Filtrar por especie:</label>
        @Html.DropDownList("filtroEspecie", especies, "-- Todas --",
            new { @class = "form-control", style = "max-width:300px;display:inline-block;" })
    </div>

    <div style="margin: 10px auto; text-align:center;">
        <label for="busqueda">Buscar por nombre:</label>
        <input type="text" id="busqueda" placeholder="Ingrese texto para filtrar" style="width:80%;" />
    </div>
</div>

@if (Model != null && Model.Any())
{
    <div id="datoTabla">
        <table id="tablaSemillas">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>     
                    <th>Especie</th>
                    <th>Ubicación</th>
                    <th>Cantidad</th>
                    <th>Fecha Almacenamiento</th>
                    <th>Editar</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in Model)
                {
                    <tr>
                        <td>@s.Id</td>
                        <td>
                            <a href="@Url.Action("Edit", "Semilla", new { id = s.Id })">
                                @s.Nombre
                            </a>
                        </td>
                        <td>@s.EspecieId</td>  
                        <td>@s.UbicacionId</td> 
                        <td>@s.Cantidad</td>
                        <td>@s.FechaAlmacenamiento.ToString("yyyy-MM-dd")</td>
                        <td><a href="@Url.Action("Edit", "Semilla", new { id = s.Id })" class="button">✏️</a></td>
                        <td><button class="button btn-eliminar" data-id="@s.Id" data-nombre="@s.Nombre">🗑️</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p style="text-align:center;">No hay semillas registradas.</p>
}

<!-- Modal Confirmación -->
<div id="modalConfirmacion" class="modal">
    <div class="modal-contenido">
        <h3>Confirmar eliminación</h3>
        <p id="textoModal"></p>
        <div style="text-align:center;margin-top:20px;">
            <button class="button" id="btnConfirmarEliminar">Eliminar</button>
            <button class="button" onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>
</div>

@section scripts {
    <script>
    // Prefijar selección si viene por query (opcional)
    const dd = document.getElementById("filtroEspecie");
    if (@(especieIdSel.HasValue ? "true" : "false")) {
        dd.value = "@(especieIdSel ?? 0)";
    }
    dd.addEventListener("change", function(){
        const val = this.value;
        const url = val && val !== "" ? "@Url.Action("Index","Semilla")" + "?especieId=" + val
                                      : "@Url.Action("Index","Semilla")";
        window.location.href = url;
    });

    document.getElementById("busqueda").addEventListener("keyup", function () {
        var texto = this.value.toLowerCase();
        var filas = document.querySelectorAll("#tablaSemillas tbody tr");
        filas.forEach(function (fila) {
            var nombre = fila.cells[1].textContent.toLowerCase();
            fila.style.display = (nombre.includes(texto)) ? "" : "none";
        });
    });

    let idSeleccionado = 0;
    document.querySelectorAll(".btn-eliminar").forEach(btn => {
        btn.addEventListener("click", function () {
            idSeleccionado = this.getAttribute("data-id");
            const nombre = this.getAttribute("data-nombre");
            document.getElementById("textoModal").textContent = `¿Desea eliminar la semilla "${nombre}"?`;
            document.getElementById("modalConfirmacion").style.display = "block";
        });
    });

    document.getElementById("btnConfirmarEliminar").addEventListener("click", function () {
        window.location.href = "/Semilla/Eliminar/" + idSeleccionado;
    });

    function cerrarModal() {
        document.getElementById("modalConfirmacion").style.display = "none";
    }
    </script>
}

